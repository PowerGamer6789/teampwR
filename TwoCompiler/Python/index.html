<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<link rel="icon" href="./favicon.ico" type="image/x-icon">
<title>TwoCompiler IDE</title>

<!-- CodeMirror -->
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/codemirror.min.css"/>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/theme/dracula.min.css"/>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/codemirror.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/codemirror/5.65.20/mode/python/python.min.js"></script>

<!-- Pyodide -->
<script src="https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js"></script>

<style>
  body, html { margin:0; height:100%; font-family:sans-serif; display:flex; flex-direction:column; background:#f5f5f5; }
  #topbar { display:flex; align-items:center; justify-content:space-between; padding:5px 10px; background:#eee; flex-shrink:0; }
  #tabs { display:flex; }
  .tab { padding:6px 12px; cursor:pointer; border-bottom:2px solid transparent; margin-right:5px; }
  .tab.active { border-bottom:2px solid #007acc; font-weight:bold; }
  #topbar-buttons { display:flex; align-items:center; gap:8px; }
  #logo { height:40px; width:auto; object-fit:contain; }
  #container { flex:1; display:flex; overflow:hidden; position:relative; }
  #editor-area { flex:1; display:flex; flex-direction:column; overflow:hidden; position:relative; }
  #editors { flex:1; display:flex; flex-direction:column; }
  .CodeMirror { flex:1; height:100%; }
  #preview { flex:1; border:none; padding:10px; overflow:auto; background:#fafafa; font-family:monospace; white-space:pre-wrap; min-width:200px; }
  @media(max-width:800px){ #container{flex-direction:column;} #preview{height:200px;width:100%;} }
  button { border:none; cursor:pointer; padding:5px 10px; border-radius:4px; }
</style>
</head>
<body>

<div id="topbar">
  <div id="tabs">
    <div class="tab active" data-file="python">Python</div>
  </div>
  <div id="topbar-buttons">
    <button id="themeToggle">Dark Mode</button>
    <button id="run">Run â–¶</button>
    <img id="logo" src="./logo.png" alt="logo"/>
  </div>
</div>

<div id="container">
  <div id="editor-area">
    <div id="editors"></div>
  </div>
  <div id="preview"></div>
</div>

<script>
  const editorsDiv = document.getElementById('editors');
  const preview = document.getElementById('preview');
  const runBtn = document.getElementById('run');
  const themeToggle = document.getElementById('themeToggle');

  const editors = {};
  let darkMode = false;

  const initial = {
    python: 'print("Hello World!")'
  };

  function createEditor(lang, code){
    return CodeMirror(editorsDiv, {
      value: code,
      mode: 'python',
      lineNumbers: true,
      theme: 'default',
      lineWrapping: true,
      viewportMargin: Infinity
    });
  }

  editors.python = createEditor('python', initial.python);

  // Pyodide setup
  let pyodideReady = false;
  let pyodide = null;
  async function loadPyodideAndPackages(){
    pyodide = await loadPyodide();
    pyodideReady = true;
  }
  loadPyodideAndPackages();

  async function runPython(){
    if(!pyodideReady){
      preview.textContent = 'Loading Python runtime...';
      return;
    }
    const code = editors.python.getValue();
    try{
      // Capture stdout
      let output = '';
      pyodide.runPython(`
import sys
from js import console
class StdoutCatcher:
    def __init__(self):
        self.content = ""
    def write(self, s):
        self.content += s
    def flush(self):
        pass
sys.stdout = StdoutCatcher()
sys.stderr = StdoutCatcher()
`);
      await pyodide.runPythonAsync(code);
      output = pyodide.runPython('sys.stdout.content + sys.stderr.content');
      preview.textContent = output;
    }catch(e){
      preview.textContent = e;
    }
  }

  runBtn.onclick = runPython;

  themeToggle.onclick = () => {
    darkMode = !darkMode;
    editors.python.setOption('theme', darkMode?'dracula':'default');
    themeToggle.innerText = darkMode?'Light Mode':'Dark Mode';
  }

  window.addEventListener('resize', ()=>{ editors.python.refresh(); });
</script>

</body>
</html>
